{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-3">Analysis Report</h2>

    <!-- Bias -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Bias</h5>
            {% if report.bias_score < 0.05 %}
                <span class="badge bg-success">Neutral</span>
            {% elif report.bias_score < 0.15 %}
                <span class="badge bg-warning text-dark">Mixed</span>
            {% else %}
                <span class="badge bg-danger">Biased</span>
            {% endif %}
            <p class="mt-2"><strong>Score:</strong> {{ (report.bias_score * 100) | round(1) }}%</p>
        </div>
    </div>

    <!-- Credibility -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Credibility</h5>
            <p>
                {% for i in range(1,6) %}
                    {% if i <= report.credibility_stars %}
                        ★
                    {% else %}
                        ☆
                    {% endif %}
                {% endfor %}
            </p>
            <p><strong>Overall Score:</strong> {{ report.credibility_raw.get("score", 0) }}</p>

            <!-- Breakdown -->
            <ul class="list-group list-group-flush mt-2 mb-3">
                <li class="list-group-item">
                    <strong>Domain score:</strong> {{ report.credibility_raw.get("domain_score", 0) }}
                </li>
                <li class="list-group-item">
                    <strong>References found:</strong> {{ report.credibility_raw.get("refs_found", 0) }}
                    (score = {{ report.credibility_raw.get("refs_score", 0) }})
                </li>
                <li class="list-group-item">
                    <strong>Emotional words:</strong> {{ report.credibility_raw.get("emotional_words", 0) }}
                    (score = {{ report.credibility_raw.get("lang_score", 0) }})
                </li>
                <li class="list-group-item text-muted">
                    <small>Last checked: {{ report.credibility_raw.get("last_checked", "—") }}</small>
                </li>
            </ul>

            <!-- Chart Container -->
            <canvas id="credibilityChart" height="120"></canvas>
        </div>
    </div>

    <!-- Quick Notes -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Quick Notes</h5>
            {% if report.notes %}
                <ul>
                {% for note in report.notes %}
                    <li>{{ note }}</li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No notes available.</p>
            {% endif %}
        </div>
    </div>

    <!-- Highlighted Text -->
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title">Highlighted Text</h5>
            <p style="white-space: pre-wrap;">{{ report.highlighted_text | safe }}</p>
        </div>
    </div>

    <!-- Original Text (accordion) -->
    <div class="accordion mb-3" id="textAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingText">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseText">
                    Show Full Original Text
                </button>
            </h2>
            <div id="collapseText" class="accordion-collapse collapse">
                <div class="accordion-body">
                    <pre style="white-space: pre-wrap;">{{ report.text }}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <a href="{{ url_for('routes.home') }}" class="btn btn-primary">Analyze Another</a>
    <a href="{{ url_for('routes.history') }}" class="btn btn-outline-secondary">View History</a>
    <a href="{{ url_for('routes.export_latest') }}" class="btn btn-success">Download PDF</a>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const ctx = document.getElementById('credibilityChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Domain', 'References', 'Language'],
            datasets: [{
                label: 'Credibility Scores',
                data: [
                    {{ report.credibility_raw.get("domain_score", 0) }},
                    {{ report.credibility_raw.get("refs_score", 0) }},
                    {{ report.credibility_raw.get("lang_score", 0) }}
                ],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 1.0
                }
            }
        }
    });
</script>
{% endblock %}
